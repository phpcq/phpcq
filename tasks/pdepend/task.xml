<project name="phpcq.task.pdepend">
    <import file="../macrodefs.xml" />
    <property file="${phpcq.basedir}/tasks/pdepend/default.properties"/>
    <target name="-check-pdepend.is-available" unless="phpcq.task.pdepend.bin">
        <find-file-in-path
            name="pdepend"
            property="phpcq.task.pdepend.bin"
            alternativepath="${phpcq.bin.pdepend}"
        >
            <only-if>
                <not><equals arg1="${pdepend.output}" arg2=""/></not>
            </only-if>
        </find-file-in-path>
    </target>
    <target name="pdepend" depends="-check-pdepend.is-available" if="phpcq.task.pdepend.bin">
        <script language="javascript"><![CDATA[
            project.setProperty(
                'pdepend.dirs',
                project.getProperty('pdepend.src').split(' ').join(',')
            );
            var baseDir=project.getProperty('basedir')
            project.setProperty(
                'pdepend.excluded.arguments',
                project.getProperty('pdepend.excluded')
                    .split(' ')
                    .filter(function(s) { return s.trim().length>0; })
                    .map(function(s) { return '--ignore=' + baseDir + '/' + s.trim(); })
                    .join(' ')
            );
        ]]></script>
        <exec dir="${basedir}" executable="${phpcq.php-cli.bin}" failonerror="true" taskname="pdepend">
            <arg value="${phpcq.task.pdepend.bin}"/>
            <arg line="${pdepend.output}"/>
            <arg line="${pdepend.excluded.arguments}"/>
            <arg line="${pdepend.dirs}"/>
        </exec>
    </target>
</project>
