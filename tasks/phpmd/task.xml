<project name="phpcq.task.phpmd">
    <property file="${phpcq.basedir}/tasks/phpmd/default.properties"/>
    <target name="-check-phpmd.installed" unless="phpmd.available">
        <available property="phpmd.installed" file="${phpcq.bin.phpmd}"/>
    </target>
    <target name="phpmd" depends="-check-phpmd.installed" if="${phpmd.installed}">
        <exec executable="${php.binary}" outputproperty="phpmd.dirs">
            <arg line="-r"/>
            <arg value="echo implode(',', array_filter(array_map('trim', explode(' ', '${phpmd.src}')))) ?: '';"/>
        </exec>
        <exec executable="${php.binary}" outputproperty="phpmd.excluded.arguments">
            <arg line="-r"/>
            <arg value="echo
            ($excludes=implode(',${basedir}/', array_filter(array_map('trim', explode(' ', '${phpmd.excluded}')))))
            ? '--exclude ${basedir}/'. $excludes
            : '';"/>
        </exec>
        <exec dir="${basedir}" executable="${php.binary}" failonerror="true" taskname="phpmd">
            <arg value="${phpcq.bin.phpmd}"/>
            <arg line="${phpmd.dirs}"/>
            <arg line="${phpmd.format}"/>
            <arg value="${phpmd.ruleset}"/>
            <arg line="${phpmd.excluded.arguments}"/>
            <arg line="${phpmd.customflags}"/>
        </exec>
    </target>
</project>
